{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/GMMF/gmmf_donut_nextjs/pages/api/predict.ts"],"sourcesContent":["// /pages/api/predict.ts\r\nimport type { NextApiRequest, NextApiResponse } from \"next\";\r\n\r\n/**\r\n * Simple price-only prediction:\r\n * - Pulls close series from your /api/series\r\n * - Computes EMA(5), EMA(20), recent slope, vol\r\n * - Projects a tiny drift to target dayOffset\r\n * - Maps to bullish probability via sigmoid\r\n *\r\n * Query:\r\n *   ?asset=GOLD&symbol=GC=F&dayOffset=14\r\n *\r\n * Response:\r\n *   {\r\n *     asset, symbol, asOf, dayOffset,\r\n *     bullishProb: 0.63,\r\n *     bearishProb: 0.37,\r\n *     signal: \"BULLISH\"|\"BEARISH\"|\"NEUTRAL\",\r\n *     features: {...}\r\n *   }\r\n */\r\n\r\ntype SeriesPoint = { date: string; close: number };\r\ntype SeriesPayload = {\r\n  symbol: string;\r\n  lastClose: number | null;\r\n  series: SeriesPoint[];\r\n  source: string;\r\n};\r\n\r\nfunction ema(values: number[], period: number) {\r\n  if (values.length === 0) return 0;\r\n  const k = 2 / (period + 1);\r\n  let e = values[0];\r\n  for (let i = 1; i < values.length; i++) e = values[i] * k + e * (1 - k);\r\n  return e;\r\n}\r\n\r\nfunction stdev(arr: number[]) {\r\n  if (arr.length < 2) return 1e-6;\r\n  const m = arr.reduce((a, b) => a + b, 0) / arr.length;\r\n  const v = arr.reduce((a, b) => a + (b - m) ** 2, 0) / (arr.length - 1);\r\n  return Math.sqrt(v) || 1e-6;\r\n}\r\n\r\nfunction sigmoid(x: number) {\r\n  return 1 / (1 + Math.exp(-x));\r\n}\r\n\r\nfunction linregSlope(y: number[]) {\r\n  // simple slope of y against x = 0..n-1\r\n  const n = y.length;\r\n  if (n < 2) return 0;\r\n  const meanX = (n - 1) / 2;\r\n  const meanY = y.reduce((a, b) => a + b, 0) / n;\r\n  let num = 0,\r\n    den = 0;\r\n  for (let i = 0; i < n; i++) {\r\n    const dx = i - meanX;\r\n    num += dx * (y[i] - meanY);\r\n    den += dx * dx;\r\n  }\r\n  return den ? num / den : 0;\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    const asset = String(req.query.asset || \"GOLD\").toUpperCase();\r\n    const symbol = String(req.query.symbol || \"\");\r\n    const dayOffset = Math.max(0, Math.min(90, Number(req.query.dayOffset ?? 0)));\r\n\r\n    // Build origin for internal call (dev/prod safe)\r\n    const host = req.headers.host || \"localhost:3000\";\r\n    const origin = host.startsWith(\"http\") ? host : `http://${host}`;\r\n\r\n    // Pull recent series (close prices)\r\n    const url = `${origin}/api/series?asset=${encodeURIComponent(asset)}${\r\n      symbol ? `&symbol=${encodeURIComponent(symbol)}` : \"\"\r\n    }`;\r\n    const r = await fetch(url);\r\n    if (!r.ok) {\r\n      const t = await r.text();\r\n      throw new Error(t || `series fetch failed ${r.status}`);\r\n    }\r\n    const data = (await r.json()) as SeriesPayload;\r\n    const rows = data.series || [];\r\n    if (!rows.length) {\r\n      return res.status(200).json({\r\n        asset,\r\n        symbol: data.symbol || symbol || null,\r\n        asOf: new Date().toISOString(),\r\n        dayOffset,\r\n        bullishProb: 0.5,\r\n        bearishProb: 0.5,\r\n        signal: \"NEUTRAL\",\r\n        reason: \"no series\",\r\n      });\r\n    }\r\n\r\n    // Use last up to 120 closes\r\n    const closes = rows.map((p) => Number(p.close)).filter(Number.isFinite);\r\n    const lastClose = closes[closes.length - 1];\r\n\r\n    // Daily returns for vol\r\n    const rets: number[] = [];\r\n    for (let i = 1; i < closes.length; i++) {\r\n      const r = (closes[i] - closes[i - 1]) / (closes[i - 1] || 1);\r\n      rets.push(r);\r\n    }\r\n    const vol = stdev(rets.slice(-60)); // 60d realized vol approx\r\n\r\n    // Momentum edge\r\n    const fast = ema(closes.slice(-120), 5);\r\n    const slow = ema(closes.slice(-120), 20);\r\n    const edge = (fast - slow) / (Math.abs(slow) || 1e-6);\r\n\r\n    // Recent slope (linear regression over last ~30 closes)\r\n    const slope = linregSlope(closes.slice(-30));\r\n    // Projected fractional drift to target date\r\n    const drift = slope / Math.max(lastClose, 1e-6) * dayOffset;\r\n\r\n    // Normalize by vol to get \"signal strength\"\r\n    const strength = (edge + drift) / (vol * Math.sqrt(Math.max(dayOffset, 1)));\r\n    // Map to probability with a tempered sigmoid (temperature 1.25)\r\n    const temp = 1.25;\r\n    const bullProb = sigmoid(strength / temp);\r\n    const bullishProb = Math.max(0, Math.min(1, bullProb));\r\n    const bearishProb = 1 - bullishProb;\r\n\r\n    const signal =\r\n      bullishProb > 0.6 ? \"BULLISH\" : bearishProb > 0.6 ? \"BEARISH\" : \"NEUTRAL\";\r\n\r\n    res.status(200).json({\r\n      asset,\r\n      symbol: data.symbol || symbol || null,\r\n      asOf: new Date().toISOString(),\r\n      dayOffset,\r\n      bullishProb: Number(bullishProb.toFixed(3)),\r\n      bearishProb: Number(bearishProb.toFixed(3)),\r\n      signal,\r\n      features: {\r\n        lastClose,\r\n        fastEMA: fast,\r\n        slowEMA: slow,\r\n        edge,\r\n        slope,\r\n        vol,\r\n        drift,\r\n        strength,\r\n      },\r\n      note:\r\n        \"Prototype price-only model. Next: blend in news tone, macro calendar, and flows for better accuracy.\",\r\n    });\r\n  } catch (e: any) {\r\n    res.status(200).json({\r\n      error: e?.message || \"predict failed\",\r\n      asset: String(req.query.asset || \"GOLD\").toUpperCase(),\r\n      asOf: new Date().toISOString(),\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}